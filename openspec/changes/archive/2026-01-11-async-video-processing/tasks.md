# 实施任务清单

## 1. API 接口改造

### 1.1 修改 run_sync 接口
- [x] 1.1.1 将 `POST /api/v1/videos/{video_id}/run_sync` 改为异步触发
- [x] 1.1.2 使用 FastAPI BackgroundTasks 或 Celery 启动后台任务
- [x] 1.1.3 修改响应格式为 `202 Accepted`
- [x] 1.1.4 返回任务启动确认信息

### 1.2 添加 reprocess 进度查询接口
- [x] 1.2.1 添加 `GET /api/v1/videos/{video_id}/reprocess` 路由
- [x] 1.2.2 实现进度查询逻辑
- [x] 1.2.3 返回任务状态和进度信息
- [x] 1.2.4 返回子任务详细进度

## 2. 数据模型更新

### 2.1 Pydantic 响应模型
- [x] 2.1.1 创建 `AsyncTaskResponse` 模型（202 响应）
- [x] 2.1.2 创建 `TaskProgressResponse` 模型（进度查询响应）
- [x] 2.1.3 创建 `SubTaskProgress` 模型（子任务进度）
- [x] 2.1.4 更新相关 schema 文件

### 2.2 数据库模型（如需要）
- [x] 2.2.1 检查现有 `processing_tasks` 表是否满足需求
- [x] 2.2.2 如需要，添加新字段（如子任务进度）
- [x] 2.2.3 创建数据库迁移脚本

## 3. 服务层实现

### 3.1 异步任务服务
- [x] 3.1.1 实现异步任务启动逻辑
- [x] 3.1.2 实现任务状态追踪
- [x] 3.1.3 实现进度计算逻辑
- [x] 3.1.4 实现子任务进度聚合

### 3.2 进度查询服务
- [x] 3.2.1 实现进度数据获取
- [x] 3.2.2 实现进度百分比计算
- [x] 3.2.3 实现任务状态映射
- [x] 3.2.4 处理任务不存在的情况

## 4. 错误处理和验证

### 4.1 参数验证
- [x] 4.1.1 验证 video_id 有效性
- [x] 4.1.2 检查视频是否存在
- [x] 4.1.3 检查是否有正在进行的任务

### 4.2 错误处理
- [x] 4.2.1 处理任务启动失败
- [x] 4.2.2 处理进度查询异常
- [x] 4.2.3 添加适当的错误日志
- [x] 4.2.4 返回友好的错误信息

## 5. 测试

### 5.1 单元测试
- [x] 5.1.1 测试异步任务启动
- [x] 5.1.2 测试进度查询逻辑
- [x] 5.1.3 测试进度计算准确性
- [x] 5.1.4 测试错误处理

### 5.2 集成测试
- [x] 5.2.1 测试完整的异步处理流程
- [x] 5.2.2 测试 run_sync 接口返回 202
- [x] 5.2.3 测试 reprocess GET 接口返回正确进度
- [x] 5.2.4 测试并发请求处理

### 5.3 端到端测试
- [ ] 5.3.1 测试真实视频处理场景
- [ ] 5.3.2 验证进度更新的实时性
- [ ] 5.3.3 验证任务完成后的状态

## 6. 文档更新

### 6.1 API 文档
- [ ] 6.1.1 更新 `run_sync` 接口文档
- [ ] 6.1.2 添加 `GET /reprocess` 接口文档
- [ ] 6.1.3 更新响应示例
- [ ] 6.1.4 添加使用说明

### 6.2 开发文档
- [ ] 6.2.1 更新架构文档
- [ ] 6.2.2 添加异步处理流程图
- [ ] 6.2.3 更新部署说明（如有变化）

## 7. 部署准备

### 7.1 配置检查
- [ ] 7.1.1 确认 Celery 配置正确
- [ ] 7.1.2 确认 Redis 连接正常
- [ ] 7.1.3 检查环境变量配置

### 7.2 数据库迁移
- [ ] 7.2.1 运行数据库迁移脚本
- [ ] 7.2.2 验证迁移结果
- [ ] 7.2.3 准备回滚方案

## 预计时间

- **API 改造**: 1-2 天
- **服务层实现**: 1-2 天
- **测试**: 1 天
- **文档和部署**: 0.5 天
- **总计**: 3.5-5.5 天

## 依赖关系

- 任务 2.2 依赖于 2.1
- 任务 3 依赖于 1 和 2
- 任务 5 依赖于 1-4
- 任务 7 依赖于所有前置任务完成
